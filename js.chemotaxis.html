<!DOCTYPE html>
<html>
<head>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<script src="http://grrrwaaa.github.io/gct753/al.min.js"></script>
<!--<script src="al.js"></script>-->
<style>
body {
	background: #eee;
	width: 512px;
	min-height: 100%;
	margin: 50px auto 50px auto;
}
</style>
</head>
<body>
<script>

al.init();


/// put your code here /////////////////////////////////////////////////////////

var dim = 128;
var sugar = new field2D(dim, dim);
var sugar_old = new field2D(dim, dim);

var max_eating_rate = 0.2;
var minimum_requirement = 0.5;
var diffusion_rate = 0.1;
var smoothing = 0.1;

var chance_of_rain = 0.02;
var rain_size = 20;
var sugar_decay = 0.998;

var tumble = 1;
	

var agents = [];

function reset() {
	var numsugars = 50;
	for (var i = 0; i < numsugars; i++) {
		sugar.set(dim*dim/(numsugars * 8), random(dim), random(dim));
	}
	
	var p = new vec2(random(), random());
	for (var i = 0; i < 40; i++) {
		var ecoli = {
			pos: vec2.random(0.1).add(p),
			dir: random() * Math.PI * 2,
			twist: 0,
			spd: 0.002,
			size: 0.02,
	
			previous_concentration: 0,
			gettingbetter: 0,
		}
		agents.push(ecoli);
	}
}
reset();

function update_agent(a) {
	// sensor:
	var c = sugar.sample(a.pos.x, a.pos.y);
	
	// how much sugar can I eat?
	var edible = Math.min(c, max_eating_rate);
	// remove it:
	sugar.update(c - edible, a.pos.x, a.pos.y);
	
	a.gettingbetter = 
		a.gettingbetter*smoothing + 
		(c - a.previous_concentration)*(1-smoothing);
	
	// action selection
	if (a.gettingbetter < 0) {
		// tumbling behavior
		a.twist = a.twist + (random() - 0.5)*tumble;
		a.twist = a.twist * 0.9;
		a.dir = a.dir + a.twist;
	} else {
		// not-tumbling behavior:
		a.twist = 0;
	}
	a.previous_concentration = c;
	
	// locomotion
	var vel = vec2.fromPolar(a.spd, a.dir);
	a.pos.add(vel);
	a.pos.wrap(1);
}

function draw_agent(a) {
	draw2D.push()
		draw2D.translate(a.pos.x, a.pos.y);
		draw2D.rotate(a.dir);
		draw2D.scale(a.size);
		
		draw2D.color(0.8, 0.3, 0);
		draw2D.circle(0, 0, 1);
		draw2D.rect(-0.5, 0, 1, 0.2);
	draw2D.pop();
}

function mouse(e, b, x, y) {
	if (e == "down" || e == "drag") {
		sugar.splat(1, x, y);
	}
}

function key(e, k) {
		(e, k);
}

function update() {
	var tmp = sugar;
	sugar = sugar_old;
	sugar_old = tmp;
	sugar.diffuse(sugar_old, diffusion_rate);
	sugar.scale(sugar_decay);
	
	// add some more sugar?
	if (random() < chance_of_rain) {
		// pick a random point:
		var p = new vec2(random(), random());
		// add some droplets:
		for (var i = 1; i < 20; i++) {
			var deviation = vec2.random(0.05);
			sugar.splat(rain_size, p.x + deviation.x, p.y + deviation.y);
		}
	}
	
	for (var i = 0; i < agents.length; i++) {
		update_agent(agents[i]);
	}
} 

function draw() {
	sugar.draw();
	
	for (var i = 0; i < agents.length; i++) {
		draw_agent(agents[i]);
	}
}

/// end of user code ///////////////////////////////////////////////////////////

al.start();
</script>
<a href="js.html">Documentation</a>
</body>
</html>