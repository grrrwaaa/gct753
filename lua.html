<!DOCTYPE html>
<html>
<head>
<meta charset='utf-8'>
<title>Lua</title>
    
<link href="css/site.css" media="screen" rel="stylesheet" type="text/css" />
<link href="css/highlight.default.css" media="screen" rel="stylesheet" type="text/css" />
  
<script src="js/jquery.js"></script>
<script src="js/socket.io.js"></script>
<script src="js/main.js" type="text/javascript"></script>

<link rel="icon" type="image/x-icon" href="favicon.ico" />
</head>
<body>
<div id="wrapper">
	
	<div class="header">
		<h1>GCT 753</h1>
		<a href="index.html">Overview</a><br/>
		<a href="software.html">Software</a><br/>
		&gt; <a href="lua.html">Lua</a> (<a href="https://github.com/grrrwaaa/gct753">GitHub</a>, <a href="http://grrrwaaa.github.com/gct753/docs/reference.html">Reference</a>)<br/>
		&gt; <a href="js.html">JavaScript</a> (<a href="https://github.com/grrrwaaa/gct753/tree/gh-pages">GitHub</a>)<br/>
		
		<br>
		<a href="introduction.html">Themes</a><br/>
		<a href="artificial_life.html">Artificial Life</a><br/>
		<a href="generative_art.html">Generative Art</a><br/>
		<a href="cellular.html">Cellular Systems</a><br/>
		<a href="agent.html">Agent Systems</a><br/>
		<a href="symbol.html">Symbol Systems</a><br/>
		<a href="evolutionary.html">Evolutionary Systems</a><br/>
		
	</div>
	<div class="section"><h2>Lua</h2>
<p>We will be using the <a href="www.lua.org">Lua</a> language (and the <a href="www.luajit.org">LuaJIT</a> implementation) for lecture and lab sessions. Lua is very easy to learn, fast, flexible and powerful. It also scales well with abstraction, which is exactly what we will need as the course progresses. By itself, Lua is lightweight, with very few built-in libraries, and certainly no graphical or audio capabilities. For these purposes I am providing runtime implementation binaries that add audiovisual capabilities. </p>
<h2>Download</h2>
<p>The code and pre-compiled binaries are in the github repository at the links below. From time to time this repo will be updated with more examples and features, so please make sure to grab these changes. You can grab the zip directly or clone (or fork) the git repo and pull the changes:</p>
<ul>
<li><a href="https://github.com/grrrwaaa/gct753/zipball/master">Download</a> <strong>ZIP file</strong></li>
<li><a href="https://github.com/grrrwaaa/gct753/tarball/master">Download</a> <strong>TAR ball</strong></li>
<li><a href="https://github.com/grrrwaaa/gct753">Clone from</a> <strong>Github</strong></li>
<li><a href="https://github.com/grrrwaaa/gct753/fork_select">Fork from</a> <strong>Github</strong></li>
</ul>
<h2>Running</h2>
<ul>
<li><strong>Windows:</strong> drag a <code>.lua</code> file onto the <code>av.exe</code> application.</li>
<li><strong>OSX / Linux:</strong> open a terminal window, <code>cd</code> to the downloaded folder, then run <code>av_osx &lt;filename&gt;</code> or <code>av_linux &lt;filename&gt;</code> where <filename> is the <code>.lua</code> file to run (e.g. <code>draw.lua</code>).</li>
</ul>
<p>While running, the <strong>Esc</strong> key will toggle full-screen mode, and the <strong>Space</strong> key will toggle the <code>update</code> function on and off. </p>
<p>Also while the script is running it will monitor the <code>.lua</code> file for changes, and reload the script automatically if this file is updated on disk. To edit <code>.lua</code> files, any text editor will do. Freely available editors with Lua syntax highlighting include:</p>
<ul>
<li><strong>Windows:</strong> <a href="http://notepad-plus-plus.org/download/v6.3.html">Notepad++</a></li>
<li><strong>OSX:</strong> <a href="http://www.barebones.com/products/textwrangler/">TextWrangler</a></li>
<li><strong>Linux:</strong> Most distributions already include a suitable text editor (such as Gedit), or can install one through apt-get.</li>
</ul>
<h2>Reference</h2>
<p>Most of the available functions and modules (both from Lua and AV) are <a href="docs/reference.html">documented in the reference pages</a>.</p>
<h1>Lua 5.1 quick tutorial</h1>
<p>Commonly compared to: JavaScript, Ruby, Python, Scheme. Notable characteristics:</p>
<ul>
<li>Fast (used widely for game engines). <a href="www.luajit.org">LuaJIT</a> can approach and sometimes exceed C. </li>
<li>Clean &amp; powerful array/dictionary data structure (table)</li>
<li>Proper lexical scoping</li>
<li>First-class functions</li>
<li>Coroutines </li>
<li>Garbage collected</li>
<li>Prototype inheritance (similar to <a href="http://en.wikipedia.org/wiki/Self_(programming_language">Self</a>)</li>
<li>Small, portable &amp; easy to embed with C</li>
<li><a href="http://www.opensource.org/licenses/mit-license.php">MIT license</a></li>
</ul>
<h2>Syntax</h2>
<pre><code class="lang-lua"><span class="comment">-- Two dashes create a comment that ends at the line break</span>
<span class="built_in">print</span>(<span class="string">"hello world"</span>)
<span class="comment">-- Note: no need for semicolons to terminate statements.</span></code></pre>
<h3>Simple types</h3>
<pre><code class="lang-lua"><span class="comment">-- Unlike C, the type information is stored with the value, not the variable; </span>
<span class="comment">-- this means that the type of a variable can change dynamically.</span>
x = <span class="number">1</span>             <span class="comment">-- x now refers to a number</span>
x = <span class="string">"foo"</span>         <span class="comment">-- x now refers to a string</span>

<span class="comment">-- check types like this:</span>
<span class="keyword">if</span> <span class="built_in">type</span>(x) == <span class="string">"number"</span> <span class="keyword">then</span> 
    <span class="comment">-- do stuff</span>
<span class="keyword">end</span>

<span class="comment">-- these lines are all equivalent</span>
<span class="comment">-- they assign the number value 1 to the variable name x:</span>
x = <span class="number">1</span>
x = <span class="number">1.0</span>
x = <span class="number">100e-2</span>  <span class="comment">-- e base10 format</span>
x = <span class="number">0x1</span> <span class="comment">--hexadecimal format</span>
<span class="comment">-- Note: all numbers in Lua are 64-bit doubles</span>

<span class="comment">-- strings:</span>
<span class="built_in">print</span>(<span class="string">"a simple string"</span>)
<span class="built_in">print</span>(<span class="string">'a simple string'</span>)

<span class="comment">-- embedding special characters and multi-line strings:</span>
x = <span class="string">'escape the \' character, and write \n a new line'</span>
x = <span class="string">[[
The double square brackets are a simple way to write strings
that span
over several
lines]]</span>

<span class="comment">-- Boolean values:</span>
t = <span class="keyword">true</span>
f = <span class="keyword">false</span>
<span class="keyword">if</span> t <span class="keyword">then</span> <span class="built_in">print</span>(<span class="string">"t!"</span>) <span class="keyword">end</span> <span class="comment">-- prints t!</span>
<span class="keyword">if</span> f <span class="keyword">then</span> <span class="built_in">print</span>(<span class="string">"f!"</span>) <span class="keyword">end</span> <span class="comment">-- prints nothing</span>

<span class="comment">-- nil indicates the absence of value. </span>
<span class="comment">-- Assigning nil to a variable marks the variable for garbage collection.</span>
n = <span class="keyword">nil</span>
<span class="comment">-- nil also evaluates to false for a predicate:</span>
<span class="keyword">if</span> n <span class="keyword">then</span> <span class="built_in">print</span>(<span class="string">"n!"</span>) <span class="keyword">end</span> <span class="comment">-- prints nothing</span></code></pre>
<h3>Structured data</h3>
<p>Lua provides only one data structure: the <em>table</em>. Tables in Lua are associative arrays, mapping <strong>keys</strong> to <strong>values</strong>. Both keys and values can be <em>any</em> valid Lua type except nil. However, the implementation makes sure that when used with continuous number keys, the table performs as a fast array. </p>
<pre><code class="lang-lua"><span class="comment">-- creating an array-like table of strings, the quick way:</span>
t = { <span class="string">"one"</span>, <span class="string">"two"</span>, <span class="string">"three"</span> }

<span class="comment">-- creating a dictionary-like table, the quick way:</span>
t = { one = <span class="number">1</span>, two = <span class="number">2</span>, three = <span class="number">3</span> }

<span class="comment">-- creating a table with both array-like and dictionary-like parts:</span>
t = { <span class="string">"one"</span>, <span class="string">"two"</span>, <span class="string">"three"</span>, one = <span class="number">1</span>, two = <span class="number">2</span>, three = <span class="number">3</span> }

<span class="comment">-- create an empty table:</span>
t = {}

<span class="comment">-- add or replace key-value pairs in the table:</span>
t[<span class="number">1</span>] = <span class="string">"one"</span>    <span class="comment">-- array-like</span>
t[<span class="string">"two"</span>] = <span class="number">2</span>    <span class="comment">-- dictionary-like</span>
<span class="comment">-- a simpler way of saying that:</span>
t.two = <span class="number">2</span>

<span class="built_in">print</span>(t.two, t[<span class="string">"two"</span>])     <span class="comment">--&gt; 2 2</span>

<span class="comment">-- remove a key-value pair by assigning the value nil:</span>
t.two = <span class="keyword">nil</span>
<span class="built_in">print</span>(t.two)            <span class="comment">--&gt; &lt;nil&gt;</span>

<span class="comment">-- create a table with a sub-table:</span>
t = {
    numbers = { <span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span> },
    letters = { <span class="string">"a"</span>, <span class="string">"b"</span>, <span class="string">"c"</span> },
}

<span class="comment">-- any Lua type (except nil) can be used as key or value</span>
<span class="comment">-- (including functions, other tables, the table itself, ...)</span>
t[x] = t</code></pre>
<p>It’s important to remember that a Lua table has two parts; an array-portion and a hash-table portion. The array portion is indexed with integer keys, starting from 1 upwards. All other keys are stored in the hash (or record) portion.</p>
<p>The array portion gives Lua tables the capability to act as ordered lists, and can grow/shrink as needed (similar to C++ vectors). Sometimes the array portion is called the list portion, because it is useful for creating lists similarly to LISP. In particular, the table constructor will insert numeric keys in order for any values that are not explicitly keyed:</p>
<pre><code class="lang-lua"><span class="comment">-- these two lines are equivalent</span>
<span class="keyword">local</span> mylist = { [<span class="number">1</span>]=<span class="string">"foo"</span>, [<span class="number">2</span>]=<span class="string">"bar"</span>, [<span class="number">3</span>]=<span class="string">"baz"</span> }:
<span class="keyword">local</span> mylist = { <span class="string">"foo"</span>, <span class="string">"bar"</span>, <span class="string">"baz"</span> }

<span class="built_in">print</span>(mylist[<span class="number">2</span>])             <span class="comment">--&gt; bar</span>

<span class="built_in">print</span>(<span class="built_in">unpack</span>(mylist))         <span class="comment">--&gt; foo bar baz</span></code></pre>
<p>Remember that Lua expects most tables to count from 1, not from 0.</p>
<h3>Iterating a table</h3>
<p>To visit <strong>all</strong> key-value pairs of a table, use a for loop like the following. Note that the order of traversal is undefined; it may be different each time.</p>
<pre><code class="lang-lua"><span class="keyword">for</span> key, value <span class="keyword">in</span> <span class="built_in">pairs</span>(mytable) <span class="keyword">do</span>
    <span class="comment">-- do things with the key and value</span>
<span class="keyword">end</span></code></pre>
<p>To visit <strong>only</strong> array-portion of a table, use one of these forms:</p>
<pre><code class="lang-lua"><span class="keyword">for</span> i = <span class="number">1</span>, #mytable <span class="keyword">do</span>
    <span class="keyword">local</span> value = t[i]
    <span class="comment">-- do things with the key and value</span>
<span class="keyword">end</span>

<span class="keyword">for</span> key, value <span class="keyword">in</span> <span class="built_in">ipairs</span>(mytable) <span class="keyword">do</span>
    <span class="comment">-- do things with the key and value</span>
<span class="keyword">end</span></code></pre>
<h3>Functions</h3>
<p>Unlike C, functions are first-class values, just like numbers, strings and tables. That means that functions can take functions as arguments, functions can return other functions as return values, functions can be keys and values in tables. It also means that functions can be created and garbage collected dynamically.</p>
<p>Functions can be declared in several ways:</p>
<pre><code class="lang-lua"><span class="comment">-- these are equivalent:</span>
sayhello = function(message)
  <span class="built_in">print</span>(<span class="string">"hello"</span>, message)
<span class="keyword">end</span>

<span class="function"><span class="keyword">function</span> <span class="title">sayhello</span><span class="params">(message)</span></span>
  <span class="built_in">print</span>(<span class="string">"hello"</span>, message)
<span class="keyword">end</span>

<span class="comment">-- using the function:</span>
sayhello(<span class="string">"me"</span>)  <span class="comment">-- prints: hello me</span>
sayhello(<span class="string">"you"</span>) <span class="comment">-- prints: hello you</span>

<span class="comment">-- replacing the function</span>
sayhello = function(message)
  <span class="built_in">print</span>(<span class="string">"hi"</span>, message)
<span class="keyword">end</span>

sayhello(<span class="string">"me"</span>)  <span class="comment">-- prints: hi me</span></code></pre>
<p>Functions can zero or more arguments. In Lua, they can also have more than one return vaue:</p>
<pre><code class="lang-lua"><span class="function"><span class="keyword">function</span> <span class="title">minmax</span><span class="params">(a, b)</span></span>
  <span class="keyword">return</span> <span class="built_in">math</span>.min(a, b), <span class="built_in">math</span>.max(a, b)
<span class="keyword">end</span>
<span class="built_in">print</span>(minmax(<span class="number">42</span>, <span class="number">13</span>)) <span class="comment">-- prints: 13 42</span></code></pre>
<h3>Logic and control flow</h3>
<pre><code class="lang-lua"><span class="comment">-- if blocks:</span>
<span class="keyword">if</span> x == <span class="number">1</span> <span class="keyword">then</span>
  <span class="built_in">print</span>(<span class="string">"one"</span>)
  <span class="comment">-- as many elseifs as desired can be chained</span>
<span class="keyword">elseif</span> x == <span class="number">2</span> <span class="keyword">then</span>
  <span class="built_in">print</span>(<span class="string">"two"</span>)
<span class="keyword">elseif</span> x == <span class="number">3</span> <span class="keyword">then</span>
  <span class="built_in">print</span>(<span class="string">"three"</span>)
<span class="keyword">else</span>
  <span class="built_in">print</span>(<span class="string">"many"</span>)
<span class="keyword">end</span>

<span class="comment">-- while loops:</span>
x = <span class="number">10</span>
<span class="keyword">while</span> x &gt; <span class="number">0</span> <span class="keyword">do</span>
  <span class="built_in">print</span>(x)
  x = x - <span class="number">1</span>
<span class="keyword">end</span>

<span class="keyword">repeat</span>
  <span class="built_in">print</span>(x)
  x = x + <span class="number">1</span>
<span class="keyword">until</span> x == <span class="number">10</span>

<span class="comment">-- numeric for loop:</span>
<span class="comment">-- count from 1 to 10</span>
<span class="keyword">for</span> i = <span class="number">1</span>, <span class="number">10</span> <span class="keyword">do</span> 
    <span class="built_in">print</span>(i) 
<span class="keyword">end</span>        
<span class="comment">-- count 1, 3, 5, 7, 9:</span>
<span class="keyword">for</span> i = <span class="number">1</span>, <span class="number">10</span>, <span class="number">2</span> <span class="keyword">do</span> 
    <span class="built_in">print</span>(i) 
<span class="keyword">end</span>
<span class="comment">-- count down from 10 to 1:</span>
<span class="keyword">for</span> i = <span class="number">10</span>, <span class="number">1</span>, -<span class="number">1</span> <span class="keyword">do</span> 
    <span class="built_in">print</span>(i) 
<span class="keyword">end</span>

<span class="comment">-- logical operators:</span>
<span class="keyword">if</span> x == y <span class="keyword">then</span> <span class="built_in">print</span>(<span class="string">"equal"</span>) <span class="keyword">end</span>
<span class="keyword">if</span> x ~= y <span class="keyword">then</span> <span class="built_in">print</span>(<span class="string">"not equal"</span>) <span class="keyword">end</span>
<span class="keyword">if</span> x &gt; <span class="number">0</span> <span class="keyword">and</span> x &lt; <span class="number">1</span> <span class="keyword">then</span> <span class="built_in">print</span>(<span class="string">"between 0 and 1"</span>) <span class="keyword">end</span></code></pre>
<h3>Lexical scoping</h3>
<p>If a variable is declared <code>local</code>, it exists for any code that follows it, until the <code>end</code> of that block. If a variable is not declared local, it becomes a global variable, belonging to the entire script. Use local variables as much as possible, as they are faster, and reduce bugs.</p>
<pre><code class="lang-lua"><span class="function"><span class="keyword">function</span> <span class="title">foo</span><span class="params">(x)</span></span>
  <span class="comment">-- a function body is a new block</span>
  <span class="keyword">local</span> y = <span class="string">"mylocal"</span>
  <span class="keyword">if</span> x == y <span class="keyword">then</span>
    <span class="comment">-- this is a sub-block of the function</span>
    <span class="comment">-- y is still visible here</span>
    <span class="built_in">print</span>(y)  <span class="comment">-- prints: mylocal</span>
  <span class="keyword">end</span>
<span class="keyword">end</span>
<span class="comment">-- y is not visible here:</span>
<span class="built_in">print</span>(y)    <span class="comment">-- prints: nil</span></code></pre>
<p>Assigning to a variable that has not been declared locally within the current block will search for that name in parent blocks, recursively, up to the top-level. If the name is found, the assignment is made to that variable. If the name is not found, the assignment becomes a global (either creating a new variable, or replacing an existing global). </p>
<pre><code class="lang-lua"><span class="comment">-- an outer variable:</span>
<span class="keyword">local</span> x = <span class="string">"outside"</span>
<span class="built_in">print</span>(x) <span class="comment">-- prints: outside</span>

<span class="comment">-- sub-block uses a local, which does not affect the outer variable:</span>
<span class="function"><span class="keyword">function</span> <span class="title">safe</span><span class="params">()</span></span>
  <span class="keyword">local</span> x = <span class="string">"inside"</span>
<span class="keyword">end</span>
safe()
<span class="built_in">print</span>(x) <span class="comment">-- prints: outside</span>

<span class="comment">-- sub-block does not use a local, and overwrites the outer variable:</span>
<span class="function"><span class="keyword">function</span> <span class="title">unsafe</span><span class="params">()</span></span>
  x = <span class="string">"inside"</span>
<span class="keyword">end</span>
unsafe()
<span class="built_in">print</span>(x) <span class="comment">-- prints: inside</span></code></pre>
<h3>Method syntax</h3>
<p>Objects in Lua that have functions as members can invoke these functions using a special colon syntax:</p>
<pre><code class="lang-lua"><span class="comment">-- create an object:</span>
myobject = { value = <span class="number">10</span> }

<span class="comment">-- add a function:</span>
myobject.printvalue = function(self)
    <span class="built_in">print</span>(self.value)
<span class="keyword">end</span>

<span class="comment">-- test it:</span>
myobject.printvalue(myobject)    <span class="comment">--&gt; 10</span>

<span class="comment">-- use the colon syntax instead passes the 'self' argument implicitly:</span>
<span class="function"><span class="keyword">function</span> <span class="title">myobject:printvalue</span><span class="params">()</span></span>
    <span class="built_in">print</span>(self.value)
<span class="keyword">end</span>

myobject:printvalue()            <span class="comment">--&gt; 10</span></code></pre>
<h3>Closures</h3>
<p>Closures arise from the mixed use of lexically scoped local variables, and higher order functions. Any function that makes use of non-local variables effectively keeps those variable references alive within it. An example explains this better:</p>
<pre><code class="lang-lua"><span class="function"><span class="keyword">function</span> <span class="title">make_counter</span><span class="params">()</span></span>
  <span class="keyword">local</span> count = <span class="number">0</span>
  <span class="keyword">return</span> function()
    count = count + <span class="number">1</span>
    <span class="built_in">print</span>(count)
  <span class="keyword">end</span>
<span class="keyword">end</span>

<span class="comment">-- call to make_counter() returns a function;</span>
<span class="comment">-- and 'captures' the local count as an 'upvalue' specific to it</span>
<span class="keyword">local</span> c1 = make_counter()
c1()  <span class="comment">-- prints: 1</span>
c1()  <span class="comment">-- prints: 2</span>
c1()  <span class="comment">-- prints: 3</span>

<span class="comment">-- another call to make_counter() creates a new function,</span>
<span class="comment">-- with a new count upvalue</span>
<span class="keyword">local</span> c2 = make_counter()
c2()  <span class="comment">-- prints: 1</span>
c2()  <span class="comment">-- prints: 2</span>

<span class="comment">-- the two function's upvalues are independent of each other:</span>
c1()  <span class="comment">-- prints: 4</span></code></pre>
<h2>Tutorial: Drawing with fields</h2>
<p>See <a href="lua.html">Lua 5.1 quick tutorial</a> for a quick introduction to the Lua language itself. </p>
<p>Most scripts start with a bunch of <code>require</code> statements, which pull in needed functionality from external library <em>modules</em>. For example:</p>
<pre><code class="lang-lua"><span class="keyword">local</span> field2D = <span class="built_in">require</span> <span class="string">"field2D"</span></code></pre>
<p>This code loads the <em>field2D</em> module (from /modules/field2D.lua), which gives us a bunch of utilities for working with 2D dense arrays. These could be useful for making cellular automata, for example. Modules usually return a table of functions. For example, the <em>field2D</em> module contains a function called <em>new</em>, which we can use to create a new field <em>object</em>:</p>
<pre><code class="lang-lua"><span class="comment">-- allocate a field with default size:</span>
<span class="keyword">local</span> field = field2D.new()

<span class="comment">-- allocate a field that is 64 cells wide and 48 cells high:</span>
<span class="keyword">local</span> field = field2D.new(<span class="number">64</span>, <span class="number">48</span>)</code></pre>
<p>Objects usually have internal state, and methods to read and modify that state or perform other behaviors. For example, we can set data in the field using the <em>:set</em> method:</p>
<pre><code class="lang-lua"><span class="comment">-- set all cells to the value 0.2:</span>
field:set(<span class="number">0.2</span>)

<span class="comment">-- set the cell at position (10,10) to the value 0.5:</span>
field:set(<span class="number">0.5</span>, <span class="number">10</span>, <span class="number">10</span>)</code></pre>
<p>The <em>av</em> application looks at the script for specially named functions in order to know how to render the screen or handle mouse and keyboard input. For example, all graphical drawing should be put inside the global <em>draw</em> function. We can use another method of the <em>field2D</em> type object here:</p>
<pre><code class="lang-lua"><span class="comment">-- the global function for rendering</span>
<span class="function"><span class="keyword">function</span> <span class="title">draw</span><span class="params">()</span></span>
    <span class="comment">-- use the :draw method of field2D to render the data stored in field:</span>
    field:draw()
<span class="keyword">end</span></code></pre>
<p>There are other functions like this; the <em>update</em> function is called frequently to update the state of the program (e.g. for animations); the <em>mouse</em> function is called whenever the mouse moves and clicks; and the <em>keydown</em> and <em>keyup</em> functions are called when keys are pressed. There are also some built-in key bindings: the Esc key will toggle full-screen, and the spacebar key will toggle updating on and off.</p>
<p>We can use the <em>mouse</em> function for example to draw into the field, whenever the mouse is down or dragging. The <em>mouse</em> function passes the kind of event, the button pressed, and the X and Y position of the mouse; but we will need to scale that position to the size of the field:</p>
<pre><code class="lang-lua"><span class="comment">-- called whenever there is mouse activity:</span>
<span class="function"><span class="keyword">function</span> <span class="title">mouse</span><span class="params">(event, button, x, y)</span></span>
    <span class="keyword">if</span> event == <span class="string">"down"</span> <span class="keyword">or</span> event == <span class="string">"drag"</span> <span class="keyword">then</span>
        <span class="comment">-- convert the mouse position from 0..1 range to the size of the field:</span>
        <span class="keyword">local</span> fieldx = x * field.width
        <span class="keyword">local</span> fieldy = y * field.height
        <span class="comment">-- write a random number into the field at this point:</span>
        field:set(<span class="built_in">math</span>.random(), fieldx, fieldy)
    <span class="keyword">end</span>
<span class="keyword">end</span>

<span class="comment">-- called whenver a key is pressed:</span>
<span class="function"><span class="keyword">function</span> <span class="title">keydown</span><span class="params">(key)</span></span>
    <span class="comment">-- if the key pressed was "c"</span>
    <span class="keyword">if</span> key == <span class="string">"c"</span> <span class="keyword">then</span>
        <span class="comment">-- set all cells of the field to zero:</span>
        field:clear()
    <span class="keyword">end</span>
<span class="keyword">end</span></code></pre>
<p>If we wanted to add a continual behavior to the field, we could use the <em>update</em> global function. For example, this function copies the value from one randomly chosen cell to another randomly chosen cell:</p>
<pre><code class="lang-lua"><span class="comment">-- called continually in the background:</span>
<span class="comment">-- (the argument is the time in seconds between updates)</span>
<span class="function"><span class="keyword">function</span> <span class="title">update</span><span class="params">(dt)</span></span>
    <span class="comment">-- pick a cell at random:</span>
    <span class="keyword">local</span> x = <span class="built_in">math</span>.random(field.width)
    <span class="keyword">local</span> y = <span class="built_in">math</span>.random(field.height)
    <span class="comment">-- get the value at this cell:</span>
    <span class="keyword">local</span> value = field:get(x, y)
    <span class="comment">-- pick another cell at random:</span>
    <span class="keyword">local</span> x = <span class="built_in">math</span>.random(field.width)
    <span class="keyword">local</span> y = <span class="built_in">math</span>.random(field.height)
    <span class="comment">-- set this cell to the value of the first:</span>
    field:set(value, x, y)
<span class="keyword">end</span></code></pre>
<p>Another useful feature of <em>field2D:set</em> is that it can take a function as its argument, instead of a value. It calls this function to derive a new value for each cell in the field. The function receives as arguments the x and y position of the cell, so for example, this code initializes the field with a horizontal gradient:</p>
<pre><code class="lang-lua">field:set(function(x, y)
    <span class="keyword">return</span> x / field.width
<span class="keyword">end</span>)</code></pre>
<p>We&#39;ve learned almost enough now to implement Conway&#39;s <em>Game of Life</em>.</p>
<pre><code class="lang-lua"><span class="comment">-- load in the "field2D" library module (from /modules/field2D.lua):</span>
<span class="keyword">local</span> field2D = <span class="built_in">require</span> <span class="string">"field2D"</span>

<span class="comment">-- choose the size of the field</span>
<span class="keyword">local</span> dimx = <span class="number">128</span>
<span class="keyword">local</span> dimy = dimx * <span class="number">3</span>/<span class="number">4</span> <span class="comment">-- (with a 4:3 aspect ratio)</span>

<span class="comment">-- allocate the field</span>
<span class="keyword">local</span> field = field2D.new(dimx, dimy)

<span class="comment">-- create a second field, to store the previous states of the cells:</span>
<span class="keyword">local</span> field_old = field2D.new(dimx, dimy)

<span class="comment">-- create a function to return either 0 or 1</span>
<span class="comment">-- with a 50% chance of either (like flipping a coin)</span>
<span class="function"><span class="keyword">function</span> <span class="title">coin</span><span class="params">()</span></span> 
    <span class="keyword">if</span> <span class="built_in">math</span>.random() &lt; <span class="number">0.5</span> <span class="keyword">then</span> 
        <span class="keyword">return</span> <span class="number">0</span>
    <span class="keyword">else</span>
        <span class="keyword">return</span> <span class="number">1</span>
    <span class="keyword">end</span>
<span class="keyword">end</span>

<span class="comment">-- use this to initialize the field with random values:</span>
<span class="comment">-- (applies 'coin' to each cell of the field)</span>
field:set(coin)

<span class="comment">-- how to render the scene (toggle fullscreen with the Esc key):</span>
<span class="function"><span class="keyword">function</span> <span class="title">draw</span><span class="params">()</span></span>    
    <span class="comment">-- draw the field:</span>
    field:draw()
<span class="keyword">end</span>

<span class="comment">-- the rule for an individual cell (at position x, y) in the field:</span>
<span class="function"><span class="keyword">function</span> <span class="title">game_of_life</span><span class="params">(x, y)</span></span>

    <span class="comment">-- check out the neighbors' previous states:</span>
    <span class="keyword">local</span> N  = field_old:get(x  , y+<span class="number">1</span>)
    <span class="keyword">local</span> NE = field_old:get(x+<span class="number">1</span>, y+<span class="number">1</span>)
    <span class="keyword">local</span> E  = field_old:get(x+<span class="number">1</span>, y  )
    <span class="keyword">local</span> SE = field_old:get(x+<span class="number">1</span>, y-<span class="number">1</span>)
    <span class="keyword">local</span> S  = field_old:get(x  , y-<span class="number">1</span>)
    <span class="keyword">local</span> SW = field_old:get(x-<span class="number">1</span>, y-<span class="number">1</span>)
    <span class="keyword">local</span> W  = field_old:get(x-<span class="number">1</span>, y  )
    <span class="keyword">local</span> NW = field_old:get(x-<span class="number">1</span>, y+<span class="number">1</span>)
    <span class="keyword">local</span> near = N + E + S + W + NE + NW + SE + SW

    <span class="comment">-- check my own previous state:</span>
    <span class="keyword">local</span> C = field_old:get(x, y)

    <span class="comment">-- apply the rule:</span>
    <span class="keyword">if</span> C == <span class="number">1</span> <span class="keyword">then</span>
        <span class="comment">-- live cell</span>
        <span class="keyword">if</span> near &lt; <span class="number">2</span> <span class="keyword">then</span>
            <span class="comment">-- loneliness</span>
            C = <span class="number">0</span>
        <span class="keyword">elseif</span> near &gt; <span class="number">3</span> <span class="keyword">then</span>
            <span class="comment">-- overcrowding</span>
            C = <span class="number">0</span>
        <span class="keyword">end</span>
    <span class="keyword">else</span>
        <span class="comment">-- dead cell</span>
        <span class="keyword">if</span> near == <span class="number">3</span> <span class="keyword">then</span>
            <span class="comment">-- reproduction</span>
            C = <span class="number">1</span>
        <span class="keyword">end</span>
    <span class="keyword">end</span>

    <span class="comment">-- return the new state:</span>
    <span class="keyword">return</span> C
<span class="keyword">end</span>

<span class="comment">-- update the state of the scene (toggle this on and off with spacebar):</span>
<span class="function"><span class="keyword">function</span> <span class="title">update</span><span class="params">(dt)</span></span>
    <span class="comment">-- swap field and field_old:</span>
    <span class="comment">-- (field now becomes old, and the new field is ready to be written)</span>
    field, field_old = field_old, field

    <span class="comment">-- apply the game_of_life function to each cell of the field: </span>
    field:set(game_of_life)
<span class="keyword">end</span>

<span class="comment">-- handle keypress events:</span>
<span class="function"><span class="keyword">function</span> <span class="title">keydown</span><span class="params">(k)</span></span>
    <span class="keyword">if</span> k == <span class="string">"c"</span> <span class="keyword">then</span>
        <span class="comment">-- set all cells to zero:</span>
        field:clear()
    <span class="keyword">elseif</span> k == <span class="string">"r"</span> <span class="keyword">then</span>
        <span class="comment">-- apply the coin rule to all cells of the field (randomizes)</span>
        field:set(coin)
    <span class="keyword">end</span>
<span class="keyword">end</span>


<span class="comment">-- handle mouse events:</span>
<span class="function"><span class="keyword">function</span> <span class="title">mouse</span><span class="params">(event, btn, x, y)</span></span>
    <span class="comment">-- clicking &amp; dragging should draw values into the field:</span>
    <span class="keyword">if</span> event == <span class="string">"down"</span> <span class="keyword">or</span> event == <span class="string">"drag"</span> <span class="keyword">then</span>

        <span class="comment">-- scale window coords (0..1) up to the size of the field:</span>
        <span class="keyword">local</span> x = x * field.width
        <span class="keyword">local</span> y = y * field.height

        <span class="comment">-- spread the updates over a wide area:</span>
        <span class="keyword">for</span> i = <span class="number">1</span>, <span class="number">10</span> <span class="keyword">do</span>
            <span class="comment">-- pick a random cell near to the mouse position:</span>
            <span class="keyword">local</span> span = <span class="number">3</span>
            <span class="keyword">local</span> fx = x + <span class="built_in">math</span>.random(span) - <span class="built_in">math</span>.random(span)
            <span class="keyword">local</span> fy = y + <span class="built_in">math</span>.random(span) - <span class="built_in">math</span>.random(span)

            <span class="comment">-- set this cell to either 0 or 1:</span>
            field:set(coin(), fx, fy)
        <span class="keyword">end</span>
    <span class="keyword">end</span>
<span class="keyword">end</span></code></pre>
<h2>Going deeper</h2>
<p>We will address more complex topics of metatables, coroutines, the C API, the LuaJIT FFI and so on as we need them.</p>
<h2>Help</h2>
<p><a href="http://www.lua.org/manual/5.1">Reference manual</a>; bookmark the <a href="http://www.lua.org/manual/5.1/index.html#index">contents</a>.</p>
<p><em>Excellent</em> text-book: <a href="http://www.lua.org/docs.html#books">Programming in Lua (second edition)</a>
<img src="http://www.lua.org/images/pil2.jpg" alt="PIL"></p>
</div>
	
	<div class="footer">
	<img src="img/snake6_small.jpg" alt="Artificial Natures"><br/>
	Graham Wakefield, 2013</div>
	
</div>
</body>
</html>